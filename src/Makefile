
FTPDIR =    /server/pub/www.fourmilab.ch/web/yourtel/
CGIDIR =    /server/bin/httpd/cgi-bin

CC = gcc
#CFLAGS = "-Wall -O3 -I$(PWD)/astro -DTESTMODE"
#CFLAGS = "-Wall -g -I$(PWD)/astro"
CFLAGS = "-Wall -O3 -I$(PWD)/astro"
LIBS = "$(PWD)/astro/astro.a  -lm"

subdirectories = astro starmaps/sao starmaps/yale sky telescope

MAKE=CC=$(CC) CFLAGS=$(CFLAGS) LIBS=$(LIBS) make

all:
	@for I in ${subdirectories}; \
	  do (cd $$I; echo "==>Entering directory `pwd`"; \
		  $(MAKE) $@ || (echo ""; echo ""; echo -e "  \a\a ====== Error in `pwd` ======\a\a"; \
				echo ""; echo "";)); \
	done


clean:
	@for I in ${subdirectories}; \
	  do (cd $$I; echo "==>Entering directory `pwd`"; \
		  $(MAKE) $@ || (echo ""; echo ""; echo -e "  \a\a ====== Error in `pwd` ======\a\a"; \
				echo ""; echo "";)); \
	done
	
#	The expected images with which the check images are compared are
#	generated by the following queries to Your Sky.

# https://www.fourmilab.ch/cgi-bin/Yoursky?date=1&utc=1969-07-20+20%3A17%3A40&lat=47%B0&ns=North&lon=7%B0&ew=East&coords=on&moonp=on&deep=on&deepm=5&consto=on&constn=on&constb=on&limag=5.5&starn=on&starnm=2.0&starb=on&starbm=2.5&imgsize=768
# https://www.fourmilab.ch/cgi-bin/Yourtel?aim=3&date=1&utc=1969-07-20+20%3A17%3A40&lon=0h&lat=0%B0&ns=North&fov=60&coords=on&moonp=on&deep=on&deepm=9&consto=on&constn=on&constb=on&limag=6.0&starn=on&starnm=3.0&starb=on&starbm=5.0&showmb=-1.5&showmd=6.0&imgsize=768&fontscale=1.0&scheme=0
# https://www.fourmilab.ch/cgi-bin/Yourhorizon?date=1&utc=1969-07-20+20%3A17%3A40&azimuth=V&azideg=250&fov=60&lat=47%B0&ns=North&lon=7%B0&ew=East&coords=on&moonp=on&deep=on&deepm=9&consto=on&constn=on&constb=on&limag=6&starn=on&starnm=3.0&starb=on&starbm=5&showmb=-1.5&showmd=6.0&terrough=0.7&imgsize=768

check: FORCE
	rm -rf check/cache
	mkdir check/cache
	( cd sky ; ./yoursky -dm5 "-e11969-07-20 20:17:40" -i768 -sm5.5 -o../check/cache/yoursky.gif 47d -7d )
	@cmp -s check/expected/yoursky.gif check/cache/yoursky.gif ; if test $$? -ne 0  ; then \
	    echo '** yoursky compare failed **' ; exit 1 ; fi
	( cd telescope ; ./yourtel -a3 -dm9 "-e11969-07-20 20:17:40" -i768 -sm6 -sn1 -so3 -sc5  -o../check/cache/yourtel.gif 0 0 60 )
	@cmp -s check/expected/yourtel.gif check/cache/yourtel.gif ; if test $$? -ne 0  ; then \
	    echo '** yourtel compare failed **' ; exit 1 ; fi
	( cd telescope ; ./yourizon -y -dm9 "-e11969-07-20 20:17:40" -i768 -ms0 -mt0 -sm6 -sn1 -so3 -sc5  -o../check/cache/yourizon.gif 47d -7d 60 250 )
	@cmp -s check/expected/yourizon.gif check/cache/yourizon.gif ; if test $$? -ne 0  ; then \
	    echo '** yourizon compare failed **' ; exit 1 ; fi
	echo rm -rf check/cache

install-test:
	cp -p sky/yoursky $(CGIDIR)/Yoursky.t
	cp -p telescope/yourtel $(CGIDIR)/Yourtel.t
	cp -p telescope/yourizon $(CGIDIR)/Yourhorizon.t

install-production:
	cp -pf sky/yoursky $(CGIDIR)/Yoursky
	cp -pf telescope/yourtel $(CGIDIR)/Yourtel
	cp -pf telescope/yourizon $(CGIDIR)/Yourhorizon

FORCE:
