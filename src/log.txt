
2005 June 26

Added a master Makefile in the home directory to build and
clean all the subdirectories, and modified the Makefiles in
the subdirectories to inherit their compiler and linker settings
from the invoking Makefile.

Moved the ephemeris generator, planetp.c, which has begun to
differentiate into two distinct versions in the sky and telescope
directories, into the astro directory, unifying it so it can be
used both by callers who know the observer's site (sky, horizon),
who call updatePlanetComplete() and those who don't (telescope),
who call updatePlanet().  In addition, all ephemeris tables which cite
azimuth now include a legend which explains the somewhat eccentric
way in which we measure it.

Asteroid and comet orbital element echoing in astro/astrelem.c
ran afoul of XHTML 1.0 validation; fixed.

Propagation of asteroid and comet elements into stateless image
requests failed because the code to transfer the orbital elements
hadn't been installed in astro/astrelem.c and astro/cometel.c; fixed.

Made handling of TESTMODE consistent across the program.  You now
set TESTMODE with a -DTESTMODE in the Makefile in the parent
directory.  Each cgi-bin URL which is generated by any program
now appends TESTFLAG, which is defined in astro/vplanet.h as the
null string if TESTMODE is not defined or ".t" if it is.  It's
up to you to create the required .t files in the CGI directory.
This means that as long as you follow the internal links among
the Your Sky components, as long as you started out in the test
version tree, you'll stay there.

2005 June 30

Added a new compile time definition, ELDEBUG, which enables
chatty output on stderr while parsing asteroid and comet orbital
elements, displays the elements parsed immediately after parsing
them, and then exits.  This allows testing element parsing without
lots of dummying up CGI argument passing.

Added logic to astro/astrelem.c and astro/cometel.c to parse
periodic and parabolic cometary orbital elements in the current
MPC 8 line format.  As for the other other formats, the parser is
reasonably forgiving about column alignment and the presence of
extraneous material before and after the "meat" of the elements.

2005 July 2

In astro/csvelements.c, the code which added a day fraction to the
epoch for cometary elements erroneously rounded off to the nearest
day due to a "=" where a "-" was intended; fixed.

Added first cut implementation of support for JPL asteroidal and
cometary elements in astro/jplelements.c, which is invoked from
astrelem.c when it sees something which looks like JPL elements.
This passes the first cut tests, but needs to be tested against
the complete JPL databases to smoke out any lingering parsing problems.

Elements in the new MPC format failed when passed on to image
generation because the "=" hammered into the time of perihelion confused
the parser when it came time to generate the image.  I added code to
astro/cometel.c to restore the original space in this line so the
elements will be identified as MPC new format when parsed by subsequent
requests.  This closes the bug previously mis-diagnosed as "aim=10
failure", which in fact was due to confusion by new format MPC elements
and didn't affect objects specified by other element syntaxes.

Memo to file: all of this should be integrated into Solar System Live
once it's suitably checked out here.

The editing of civil time from a Julian day fraction in the ejd()
function of astro/astrelem.c (used only when displaying the epoch
and perihelion date when "Echo elements" is selected, was off by
12 hours.  It rolled its own time editor rather than call jhms as
most other code does.  I imported jhms() into astro/astro.c from
the copy in Earth and Moon Viewer and rewrote ejd() to use it;
problem solved.

2005 July 3

Removed some #defines translating obsolete Solaris C library
functions in astro/astrelem.c and astro/cometel.c.

Added "const" declaration to tables of periodic terms in
astro/astro.c, astro/pluto.c, and astro/vsop87.c.

2005 July 9

The state machine parser in astro/jplelements.c which finds the
a/q field in the elements regardless of column layout failed if
the field had more than one digit before the decimal place, as is
the case for Centaurs and KBOs; fixed.

2005 July 24

Fixed the Planet() macro in astro/vsop87.c, which used a double
ampersand instead of a single ampersand when ANDing the planet
number against the mask of planets for which calculation is
required in the call to planets().  In fact, this caused no
problem because astro/planetp.c always calls planets() to
compute all planets, but it's better fixed in case we add
something which requires selective calculation.  (This was
found and fixed in Solar System Live, which does do selective
calculation.)

Integrated the version of astro/asteroid.c from Solar System Live
which uses the Landgraf/Stumpff algorithm to compute the position of
objects on parabolic and hyperbolic orbits.

Moved the maxOrbitalElements definition to astro/vplanet.c and
replaced hard coded sizes for the elements arrays in astro/packargs.c,
sky/vplanet.c, and telescope/vplanet.c.  Note that the code in
the vplanet.c files already protects against an attempt to overflow
a buffer by supplying more lines of orbital elements than the
program was built to accommodate.

2005 August 11

When generating a dynamic image for a stateless request, the parameter
block propagated the "-h" option, which set the "html" flag which,
in turn, caused the "Content-Type" to be set to "text/html" instead
of the correct "image/gif".  This confused some browsers, especially
if the dynamic image URL was pasted directly into the location bar
instead of used in the context of an <img> tag.  I added code to
clear the html flag when processing a dynamic image request.

The headers generated for a dynamic image request included a
"Cache-Control: no-cache" which was redundant since we now
automatically append a "Cache-Control: private" to all cgi-bin
requests in the Apache httpd.conf.  I commented out the redundant
Cache-control item, explaining why.  The "Pragma: no-cache",
intended for older browsers and caches, is still generated
for dynamic image requests.

2006 September 13

I finally found a reproducible case of the notorious and highly
sporadic "yoursky time limit exceeded" bug.  It can be created
by running the direct command:

    ./yoursky -l -j -e22453992 -k1 -p1 -ca0 -cb1 -cn1 -co1 -ds1 -sb1 -sn1 - 2 -100 | tail --lines=+4 >/tmp/a.gif

and fails both when the program is built with the -g and -O3 options.
Looking at it under GDB, we appear to be performing zillions of massively
deep recursions in the drawcurveline() function in astro/project.c.
Zillions?...well, how about:
    Drawcurveline: 435 level zero calls, 73,692,720 total calls.
and that's just calls up until the time limit expired.

Well, this turns out to have been a bug in this code since its distant
origin in Alan Paeth's Starchart program.  The drawcurveline()
function in project.c called xform() in project.c without checking
whether the window co-ordinates returned were within the window, as
indicated by the inregion flag.  If they were outside, the transformed
values were undefined, and could cause a loop in drawcurveline or
functions it calls.  I changed the test for recursion to require
inregion for the midpoint to be true to propagate the recursion
deeper.  I've rebuilt a version with this fix and put it into
provisional production on Server1 to see how it behaves.  I also added
a log message written to stderr (which Apache will transcribe to the
error_log) for every request which exceeds the time limit; this should
make it easier to identify problems like this in the future.

2006 September 14

Cleaned up some code and indentation in astro/project.c to make it easier
to figure out the next puzzle that emerges thence.

Integrated the htmlutil.c functions from Earth and Moon Viewer into the
astro directory to handle quoting of text in HTML emitted in result documents.

2006 September 18

Fixed an error in the escape_html_content() function in astro/htmlutil.c
which failed to zero-terminate the result string, resulting in failure
of the sanity check assertion at the end of the function.

Integrated calls to escape_html_content() and write_html_content() into
sky/vplanet.c, astro/astrelem.c, and astro/planetp.c to escape the
user-supplied asteroid name and elements where they are echoed
into the HTML reply.  This protects against the user crafting a
request with embedded HTML which performs some nefarious deed.

Integrated HTML escape protection into telescope/vplanet.c, which handles
the telescope and horizon views.

2006 October 26

Added uncgi.c (from Solar System Live) to the astro library.
It is built and included in the library archive by the
Makefile and the function prototype is included in
vplanet.h.

Integrated code to read orbital elements from the
elementSpecification array set by the built-in CGI argument
processor in astro/astrelem.c.  The code was lifted directly
from Solar System Live.

Added built-in CGI argument processing to sky/vplanet.c.

To keep everything working while we're upgrading stuff,
I added the global definitions for uncgi() processing to
telescope/vplanet.c to avoid undefineds in the link, but
the code which actually uses them isn't there yet.

Integrated code from Solar System Live so that when compiled
with TESTMODE sky/vplanet.c always uses a GET request for
the "Update" button.  This makes it easier to track down problems
since the arguments are visible on the URL line.

The openRSC function in sky/sky.c did not call locfile() to append
the directory name of the CSV resource it was opening--it assumed
the shell script had change the current directory to cgi-execitables.
I modified it to call locfile(), which I made external in
sky/vplanet.c.

2006 December 29

The check box to toggle star names in sky/vplanet.c did not work
in directCall mode because the name of its CGI argument was
confused with that which controls the limiting magnitude for
star names--fixed.

Added directCall logic to telescope/vplanet.c.  This code is somewhat
more complicated than for the sky map because this file handles both
telescope and horizon views and the CGI arguments differ for the
two requests.  When processing directCall arguments, we distinguish
a horizon request by the presence of the substring "Yourhorizon" in the
program name field with which were were invoked.

The handling of the "WWW_z" option in telescope/vplanet.c ran afoul of
our code which supplies default values for unspecified fields.
I modified the WWW_z code to set a flag which causes subsequent
options for which it supplies the values to be ignored.

The CSV resource load code in telescope/sky.c needed to call locfile()
to assemble the path name of the resource file.

The test install target in the Makefile for Yourhorizon was
incorrect and all production targets were wrong (pointing to the
old executables, not the former shell scripts).  All are now
fixed.

Added a message to stderr() which will show up in the HTTP error log
if Yourtel or Yourhorizon aborts due to time limit exceeded; this
was already present in sky.c.

2007 January 14

Some legacy code conditional on ELDEBUG (the orbital elements
debugging flag) in telescope/vplanet.c invoked astrelem() to
pre-verify the orbital elements in a context which no longer works
with our built-in UNCGI processing and stateless operation.  I
removed the offending code, as had already been done in
sky/vplanet.c.

Integrated the current production versions of the element processing
scripts in tools/:
    UpdateYourskyJPLOrbitalElements
    Yoursky_elements_pastname.pl
    Yoursky_elements_pastnum.pl
    Yoursky_elements_pcomets.pl
from server/cron.

Modified:
    Yoursky_elements_pastname.pl
    Yoursky_elements_pastnum.pl
    Yoursky_elements_pcomets.pl
to remove the uncgi call in URLs invoking Yourtel for object
links.

2007 January 15

If the last line of an orbital element specification lacked a line
feed character at the end, element_rs() in astro/astrelem.c would fail
to parse it, which caused, for example, JPL orbital elements specified
in URLs in the object catalogue to fail.  I added code to the
WWW_elements processing logic in sky/vplanet.c and telescope/vplanet.c
to allocate a new buffer, copy the elements, and append a new line
character if none is supplied in the argument.

2009 March 6

Some MPEC orbital elements now include right-justified comments on
the first (name) line.  This could lead to a buffer overflow in
astrelem.c and cometel.c (both in the astro directory) because the
buffer on the stack into which the name field was stored was 80
characters in length and did not account for the trailing zero
character in this case.  I increased the buffer size to 82
characters and converted all string copies in these files and
in csvelements.c to use strlcpy(), which I added to the astro
directory as strlcpy.c.  This BSD function guarantees that a string
copy will not overflow the destination buffer whose length is
passed as a third argument, and that the destination string will
always be zero terminated.

Added code to astrelem.c to delete comments from the title line
of MPEC orbital elements.  We detect a comment by the appearance of
five or more consecutive spaces after the object name and elide
anything from that point to the end of line.

Release 2.5.

2011 January 27

Increased maximum image size in sky/vplanet.c and telescope/vplanet.c
to 4096 and made it specified by a definition of MAX_IMAGE_SIZE
instead of hard coded in the option processing section.  I suppose
it would have been more elegant to make this a global configuration
parameter which was imported into all the binary builds but, heck,
we only change this every decade or so.

Added IAU constellation abbreviations as a fourth field in the
sky/cnames.csv and telescope/cnames.csv databases.  Copied this into
the /server/bin/httpd/cgi-executables directory of the test server.
Note that this will have to be done on every server on which this update
is deployed, and that it cannot be done before since otherwise the
abbreviation field will be appended to the constellation name
by the primitive scanner used to read these records.

Added code in sky/sky.c and sky/vplanet.c to allow the user to select
display of the IAU constellation abbreviations instead of the full name.

Ported changes to display IAU constellation abbreviations to
telescope/sky.c and telescope/vplanet.c.

Some folks dislike our choice of font size for legends in the
sky maps.  I added a "Font scale" item to the control panel, which the
user can set to value constrained to the limits of 0.1 to 3.0 which
adjusts our font size scaled to the image size accordingly.

Ported the "Font scale" facility from Sky to Telescope and Horizon.

Release 2.6.

2022 March 19

Began development of version for posting on GitHub.

Converted all source code files to the Fourmilab convention of all
tabs expanded and no trailing white space.

Set all files to read/write permission.  Some of the CSV databases
and icon files were previously read-only, which conflicts with the
spirit of management with Git.

2022 March 22

Asteroid 541132 Leleakuhonua broke our Translate_JPL/trans_ast program
which extracts asteroid elements from the JPL database.  This object
was the first in the database to have a semi-major axis greater than or
equal to 1000 astronomical units.  This caused a field overflow, which
Fortran handly turned into all asterisks, which caused a fatal parse
error when the downstream Perl programs tried to read it.  I added a
character to the field to avoid the overflow.  Since the Perl programs
read them as white space delimited fields, no changes were needed in
them.

